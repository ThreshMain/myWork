var REFRESH_MINIMUM_VISIBLE=10;var REFRESHING_KEYS=['sky-left-refresh','sky-right-refresh','half-page-right-refresh','half-page-left-refresh','right-mpu-refresh','leaderboard-below-refresh',];var MAX_VISIBLE_SCROLL=396;var MAX_REFRESHES=60;var PAGE_VISIBILITY_DEBOUNCE_MS=200;var lastRefresh=new Date();var impressionNumber=1;var crazyRefreshTimer;var adsVisibleSeconds=0;var lastVisibilityStart=new Date();var lastPageInvisibleEvent=new Date(2018,1,1);var isFullscreen=false;var isPageVisible;var isScrolledOut=false;var REFRESH_INTERVAL=56;var TIMER_BASED_REFRESH_TIMEOUTS={2000:1.0,};var EXIT_FULLSCREEN_TIMEOUTS={1000:1.0,};function getRefreshingKeys(){var keys=getAdUnitKeys();return keys.filter(function(key){return REFRESHING_KEYS.indexOf(key)>-1});}
function getRefreshingAdUnitCodes(){var refreshingKeys=getRefreshingKeys();return refreshingKeys.map(function(key){return ALL_UNITS[key]['adUnit']['code'];});}
function getRefreshInterval(){return REFRESH_INTERVAL;}
function handleRefresh(timerBased){if(impressionNumber<MAX_REFRESHES){initializeTimer(getRefreshInterval());lastRefresh=new Date();lastVisibilityStart=new Date();adsVisibleSeconds=0;impressionNumber++;var timeout;var dfp={timer_based_refresh:(!!timerBased).toString()};if(timerBased){timeout=getWeightedRandom(TIMER_BASED_REFRESH_TIMEOUTS);dfp['exit_fs_timeout']='not_applicable';dfp['timer_ref_timeout']=timeout.toString();}
else{timeout=getWeightedRandom(EXIT_FULLSCREEN_TIMEOUTS);dfp['exit_fs_timeout']=timeout.toString();dfp['timer_ref_timeout']='not_applicable';}
CrazygamesAds.refreshAds({codes:getRefreshingAdUnitCodes()},{timeout:timeout,dfp:dfp});}}
function refreshAllowed(){var secondsSinceLastRefresh=(new Date()-lastRefresh)*0.001;var visibility=adsVisibleSeconds>REFRESH_MINIMUM_VISIBLE&&secondsSinceLastRefresh>getRefreshInterval();return visibility&&!isScrolledOut&&!isFullscreen&&isPageVisible;}
function initializeTimer(intervalSeconds){clearTimeout(crazyRefreshTimer);crazyRefreshTimer=setTimeout(function(){handleRefresh(true)},intervalSeconds*1000);}
function adsInvisible(){clearTimeout(crazyRefreshTimer);adsVisibleSeconds+=(new Date()-lastVisibilityStart)*0.001;}
function adsVisible(){lastVisibilityStart=new Date();if(refreshAllowed()){handleRefresh(false);}else{var intervalSeconds=Math.max(REFRESH_MINIMUM_VISIBLE,getRefreshInterval()-(new Date()-lastRefresh)*0.001);initializeTimer(intervalSeconds);}}
function pageVisibleHandler(){if(!isFullscreen&&(new Date()-lastPageInvisibleEvent)>PAGE_VISIBILITY_DEBOUNCE_MS){adsVisible();}else{}}
function pageInvisibleHandler(){lastPageInvisibleEvent=new Date();if(!isFullscreen){setTimeout(function(){if(!isPageVisible){adsInvisible();}else{}},PAGE_VISIBILITY_DEBOUNCE_MS)}}
function setPageVisibilityListeners(becomesActiveCallback,becomesInactiveCallback){var handleVisibilityChange=function(e){if(document[hidden]){isPageVisible=false;becomesInactiveCallback();}else{isPageVisible=true;becomesActiveCallback();}};var hidden,visibilityChange;if(typeof document.hidden!=="undefined"){hidden="hidden";visibilityChange="visibilitychange";}else if(typeof document.msHidden!=="undefined"){hidden="msHidden";visibilityChange="msvisibilitychange";}else if(typeof document.webkitHidden!=="undefined"){hidden="webkitHidden";visibilityChange="webkitvisibilitychange";}
if(typeof document.addEventListener!=="undefined"&&typeof document[hidden]!=="undefined"){document.addEventListener(visibilityChange,handleVisibilityChange,false);if(!document[hidden]){isPageVisible=true;becomesActiveCallback();}else{isPageVisible=false;becomesInactiveCallback();}}}
function setFullscreenListeners(exitsFullscreenCallback,entersFullscreenCallback){function fullscreenHandler(e){if(document['fullscreen']||document['mozFullScreen']||document['webkitIsFullScreen']||document['msFullscreenElement']){isFullscreen=true;entersFullscreenCallback();}else{isFullscreen=false;exitsFullscreenCallback();ga('send','event','native-fullscreen','click','exit');}}
document.addEventListener('fullscreenchange',fullscreenHandler,false);document.addEventListener('webkitfullscreenchange',fullscreenHandler,false);document.addEventListener('mozfullscreenchange',fullscreenHandler,false);document.addEventListener("MSFullscreenChange",fullscreenHandler,false);}
function setScrollingListeners(onScrolledIn,onScrolledOut){function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)func.apply(context,args);};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)func.apply(context,args);};};var scrollCheck=debounce(function(){if(window.scrollY<MAX_VISIBLE_SCROLL&&isScrolledOut){isScrolledOut=false;onScrolledIn();}else if(window.scrollY>MAX_VISIBLE_SCROLL&&!isScrolledOut){isScrolledOut=true;onScrolledOut();}},500);window.addEventListener('scroll',scrollCheck);}
setFullscreenListeners(adsVisible,adsInvisible);setPageVisibilityListeners(pageVisibleHandler,pageInvisibleHandler);setScrollingListeners(adsVisible,adsInvisible);